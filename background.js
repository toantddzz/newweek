(()=>{var r=new Map,i=new Map,u=async()=>{var a;let t=await chrome.tabs.query({active:!0,currentWindow:!0});return(a=t==null?void 0:t[0])==null?void 0:a.id},w=async()=>new Promise(t=>{chrome.storage.local.get("connectedTabsIds",a=>{t(JSON.parse(a.connectedTabsIds||null)||[])})}),y=async t=>{if(t){let a=await w();a.includes(t)||await chrome.storage.local.set({connectedTabsIds:JSON.stringify([...a,t])})}},f=async t=>{let a=await w();a.includes(t)&&await chrome.storage.local.set({connectedTabsIds:JSON.stringify(a.filter(e=>e!==t))})},m=async()=>{let t=(await chrome.tabs.query({})).map(n=>n==null?void 0:n.id),e=(await w()).filter(n=>t.includes(n));await chrome.storage.local.set({connectedTabsIds:JSON.stringify(e)})},p=(t,a,e)=>{var o;let n=new URLSearchParams;n.set("origin",a.origin),n.set("request",JSON.stringify(t.data)),(o=t.data.params)!=null&&o.network&&n.set("network",t.data.params.network),chrome.windows.getLastFocused(async c=>{let l=await chrome.windows.create({url:"index.html#"+n.toString(),type:"popup",width:460,height:675,top:c.top,left:c.left+(c.width-460),focused:!0}),d=h=>{if(h===l.id){let s=r.get(t.data.id);s&&(r.delete(t.data.id),s({error:"Operation cancelled",id:t.data.id})),chrome.windows.onRemoved.removeListener(d)}};chrome.windows.onRemoved.addListener(d)}),r.set(t.data.id,e)},b=async(t,{connection:a,networkId:e,trustedApps:n})=>{var o;return(a==null?void 0:a.blockchain)!=="solana"||!e||!((o=n==null?void 0:n[e])!=null&&o[t])?null:a},_=async(t,a,e)=>{chrome.storage.local.get(["connection","network_id","trusted_apps"],async n=>{let o=await u(),c=async(h,s)=>{await e(h,s),await y(o)},l={connection:JSON.parse(n.connection||null),networkId:JSON.parse(n.network_id||null),trustedApps:JSON.parse(n.trusted_apps||null)},d=await b(a.origin,l);d?await c({method:"connected",params:{publicKey:d.address},id:t.data.id}):p(t,a,c)})},k=async(t,a,e)=>{await e({method:"disconnected",id:t.data.id});let n=await u();await f(n)},I=(t,a,e)=>{if(t.data.method==="get")return e(i.get(t.data.key)),!0;t.data.method==="set"?(i.set(t.data.key,t.data.value),["password","active_at"].includes(t.data.key)&&chrome.alarms.create("salmon_lock_alarm",{delayInMinutes:5})):t.data.method==="delete"?i.delete(t.data.key):t.data.method==="clear"&&i.clear()};chrome.runtime.onMessage.addListener((t,a,e)=>{if(a.id===chrome.runtime.id){if(t.channel==="salmon_contentscript_background_channel")return t.data.method==="connect"?_(t,a,e):t.data.method==="disconnect"?k(t,a,e):p(t,a,e),!0;if(t.channel==="salmon_extension_background_channel"){let n=r.get(t.data.id);r.delete(t.data.id),n(t.data,t.data.id)}else t.channel==="salmon_extension_stash_channel"&&I(t,a,e)}});chrome.alarms.onAlarm.addListener(t=>{t.name==="salmon_lock_alarm"&&i.delete("password")});chrome.tabs.onRemoved.addListener(t=>{f(t)});m();})();
